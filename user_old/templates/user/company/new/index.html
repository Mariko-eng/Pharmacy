{% extends 'base/company/index.html' %}
{% load widget_tweaks %}


{% block pagetitle%}
<div class="pagetitle">
    <h1>Hello, {{ request.session.company_name|default:"Guest" }}!</h1>
    
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">
                Company Users
            </a></li>
        </ol>
    </nav>
</div><!-- End Page Title --> 
{% endblock %} 

{% block content %}

<div class="container-fluid">
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">User Registration Form</h5>
            
            <div class="p-2">
                <form id = "userForm" method="post" novalidate> 
                    {% csrf_token %}
                    <div class="row mb-3">
                        <label for="name" class="col-sm-3 col-form-label">First Name *</label>
                        <div class="col-sm-9">
                            {% if form.errors.first_name %}
                            {% render_field form.first_name|add_class:"form-control is-invalid"|attr:"id:first_name" %}
                            {% else %}
                            {% render_field form.first_name|add_class:"form-control is-valid"|attr:"id:first_name" %}
                            {% endif %}
                            <div id = "" class="invalid-feedback">
                                {{  form.errors.first_name.0  }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label for="name" class="col-sm-3 col-form-label">Last Name *</label>
                        <div class="col-sm-9">
                            {% if form.errors.last_name %}
                            {% render_field form.last_name|add_class:"form-control is-invalid"|attr:"id:last_name" %}
                            {% else %}
                            {% render_field form.last_name|add_class:"form-control is-valid"|attr:"id:last_name" %}
                            {% endif %}
                            <div id ="" class="invalid-feedback">
                                {{  form.errors.last_name.0  }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label for="name" class="col-sm-3 col-form-label">Email *</label>
                        <div class="col-sm-9">
                            {% if form.errors.email %}
                            {% render_field form.email|add_class:"form-control is-invalid"|attr:"id:email" %}
                            {% else %}
                            {% render_field form.email|add_class:"form-control is-valid"|attr:"id:email" %}
                            {% endif %}
                            <div id = "" class="invalid-feedback">
                                {{  form.errors.email.0  }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label for="name" class="col-sm-3 col-form-label">Phone Number *</label>
                        <div class="col-sm-9">
                            {% if form.errors.phone_number %}
                            {% render_field form.phone_number|add_class:"form-control is-invalid"|attr:"id:phone_number" %}
                            {% else %}
                            {% render_field form.phone_number|add_class:"form-control is-valid"|attr:"id:phone_number" %}
                            {% endif %}
                            <div id = "" class="invalid-feedback">
                                {{  form.errors.email.0  }}
                            </div>
                        </div>
                    </div>
                    
                    <hr/>
                    
                    <div class="row mb-3">
                        <label for="roles" class="col-sm-3 col-form-label">Select Role/s *</label>
                        <div class="col-sm-9">
                            <div class ="d-flex">
                                <div class="row">
                                    {% for checkbox in form.roles %}
                                    <div class="col-sm-4">
                                        <div class="form-check">
                                            {{ checkbox }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% if form.errors.roles %}
                            <div id = "" class="text-danger">
                                {{ form.errors.roles.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr/>
                    
                    <div class="row mb-3">
                        <label for="branches" class="col-sm-3 col-form-label">Access to Branches *</label>
                        <div class="col-sm-9">
                            {% if form.branches|length > 0 %}
                            <div class ="d-flex">
                                {% render_field form.access_to_all_branches|attr:"class:form-check-input id:branch_all" type="checkbox" %}
                                <label for="branches_all" class="mx-2 col-form-label">Select all branches</label>
                            </div>
                            <div class ="d-flex">
                                <div class="row">
                                    {% for checkbox in form.branches %}
                                    <div class="col-sm-4">
                                        <div class="form-check">
                                            {{ checkbox }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <a href="{% url 'user:company-branch-list' company_id=company.id %}" style="width: 250px; height:70px; display: inline-block; text-align: start; text-decoration: none;">
                                    <i class="bi bi-plus"></i><span>Click here to add a branch</span>
                                </a>
                                {% endif %}
                            </div>
                          {% if form.errors.branches %}
                            <div id = "" class="text-danger">
                                {{ form.errors.branches.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <hr/>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <button type="reset" class="btn btn-secondary">Reset</button>
                </div>
                
            </form>
        </div>
    </div>
</div>
</div>

<script type='text/javascript'>
    $(document).ready(function() {
        
        // console.log($('input[name="role"]:checked').val())
        
        if($('input[name="roles"]:checked').val() == undefined){
            $('input[name="branches"]').prop('checked', false);
            $('input[name="branches"]').prop('disabled', true);
            $('input[name="access_to_all_branches"]').prop('checked', false);
            $('input[name="access_to_all_branches"]').prop('disabled', true);
        }
        
        
        function handleRolesSelection() {
            var selectedRoles = $('input[name="roles"]:checked').val();
            
            if(selectedRoles === undefined){
                $('input[name="roles"]').prop('disabled', false);
            }else if (selectedRoles === "Branch Admin" || selectedRoles === "Company Admin"){
                // Disable all checkboxes
                $('input[name="roles"]').prop('disabled', true);
                $('input[name="roles"]').prop('checked', false);
                
                // Enable the selected role checkbox
                $('input[name="roles"][value="' + selectedRoles + '"]').prop('disabled', false);
                $('input[name="roles"][value="' + selectedRoles + '"]').prop('checked', true);
                
                // Clear and hide the error message
                $('#rolesError').hide();
            }
            
            if (selectedRoles === "Company Admin"){
                $('input[name="branches"]').prop('checked', false);
                $('input[name="branches"]').prop('disabled', true);
                $('input[name="access_to_all_branches"]').prop('checked', false);
                $('input[name="access_to_all_branches"]').prop('disabled', true);
            }else{
                $('input[name="branches"]').prop('disabled', false);
                $('input[name="access_to_all_branches"]').prop('disabled', false);
            }
            
        }
        
        // Attach the function to the change event of the roles checkboxes
        $('input[name="roles"]').change(handleRolesSelection);
        
        function handleBranchesSelection() {
            var branchAllChecked = $('input[name="access_to_all_branches"]').prop('checked');
            
            if(branchAllChecked){
                $('input[name="branches"]').prop('checked', true);
            }else{
                $('input[name="branches"]').prop('checked', false);
            }
            
        }
        
        $('input[name="access_to_all_branches"]').change(handleBranchesSelection);
        
        /**
        
        $('userForm').submit(function(e){
            e.preventDefault()
            
            var selectedBranch = $('input[name="branch"]:checked').val();
            
            console.log(selectedBranch)
            
        })
        **/
        
    })
    
</script>
{% endblock %}