{% extends 'base/super/index.html' %}
{% load widget_tweaks %}


{% block pagetitle%}
<div class="pagetitle">
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Users & Access</a></li>
        </ol>
    </nav>
</div><!-- End Page Title --> 
{% endblock %}

{% block content %}

<div class="container-fluid">
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Users & Roles</h5>
            
            <!-- Default Tabs -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">Users</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button" role="tab" aria-controls="roles" aria-selected="false">Roles</button>
                </li>
            </ul>
            <div class="tab-content pt-2" id="myTabContent">
                <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                    <div class="d-flex flex-column">
                        <div class="d-flex flex-row justify-content-end p-2">
                            <button class="btn btn-outline-primary" style="width: 150px;" data-bs-toggle="modal" data-bs-target="#selectUserTypeModal"><i class="bi bi-plus"></i><span>Add User</span></button>
                        </div>
                        <div class="table-responsive small">
                            <table id="bootstrapdatatable" class="datatable table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Contact</th>
                                        <th scope="col">Company</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>{{user.created_at}}</td>
                                        <td>{{user.role}}</td>
                                        <td>{{user.name}}</td>
                                        <td>{{user.email}}</td>
                                        <td>{{user.phone_number}}</td>
                                        <td>{{user.company.name}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="roles" role="tabpanel" aria-labelledby="roles-tab">
                    <div class="d-flex flex-column">
                        <div class="d-flex flex-row justify-content-end">
                            <button class="btn btn-primary" style="width: 100px;" data-bs-toggle="modal" data-bs-target="#createProductCategoryModal"><i class="bi bi-plus"></i><span>Add</span></button>
                        </div>
                        <div>
                            <h6 class="card-title">Predefined Roles</h6>
                            <div class="table-responsive small">
                                <table id="bootstrapdatatable" class="datatable table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th scope="col">Name</th>
                                            <th scope="col">Action 1</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in groups_static %}
                                        <tr>
                                            <td>{{item.name}}</td>
                                            <td><a href="{% url 'user:super-roles-permissions-edit' item.id %}"><i class="bi bi-pencil"></i>Edit Permissions</a></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h6 class="card-title">Generic Roles</h6>
                            <div class="table-responsive small">
                                <table id="bootstrapdatatable" class="datatable table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th scope="col">Name</th>
                                            <th scope="col">Action 1</th>
                                            <th scope="col">Action 2</th>
                                            <th scope="col">Action 3</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in groups_dynamic %}
                                        <tr>
                                            <td>{{user.name}}</td>
                                            <td>Edit Role</td>
                                            <td>Edit Permissions</td>
                                            <td>Delete Role</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Default Tabs -->
        </div>
    </div>
    
    <div class="modal fade" id="selectUserTypeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <form id = "selectUserTypeForm" class="row g-3 needs-validation" method="post" novalidate >
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-center">Which user do you want to Add?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <br/>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="user_type" value="superUser" id="user_type1">
                            <label class="form-check-label" for="user_type1">
                                Super User
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="user_type" value="companyAdmin" id="user_type1">
                            <label class="form-check-label" for="user_type1">
                                Company Admin
                            </label>
                        </div>
                        <div id ="user_type_error" class="d-none text-danger">Please select a user type.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Continue</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal fade" id="createSuperUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <form id = "superUserForm" class="row g-3 needs-validation" method="post" novalidate >
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-center">Super User Registration Form</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <br/>
                        {% csrf_token %}
                        <input type="hidden" name="form_prefix" value="{{ superUserForm.prefix }}">
                        <div class="row mb-3">
                            <label for="name" class="col-sm-2 col-form-label">First Name</label>
                            <div class="col-sm-10">
                                {% render_field superUserForm.first_name|add_class:"form-control"|attr:"id:first_name" %}
                                <div id = "firstNameError" class="invalid-feedback">
                                    Provide a valid first name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="name" class="col-sm-2 col-form-label">Last Name</label>
                            <div class="col-sm-10">
                                {% render_field superUserForm.last_name|add_class:"form-control"|attr:"id:last_name" %}
                                <div id = "lastNameError" class="invalid-feedback">
                                    Provide a valid last name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="name" class="col-sm-2 col-form-label">Email</label>
                            <div class="col-sm-10">
                                {% render_field superUserForm.email|add_class:"form-control"|attr:"id:email" %}
                                <div id = "emailError" class="invalid-feedback">
                                    Provide a valid email
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="name" class="col-sm-2 col-form-label">Phone Number</label>
                            <div class="col-sm-10">
                                {% render_field superUserForm.phone_number|add_class:"form-control"|attr:"id:phone_number" %}
                                <div id = "phoneNumberError" class="invalid-feedback">
                                    Provide a valid phone number
                                </div>
                            </div>
                        </div>
                        {% comment %} <button type="submit">Create Company</button> {% endcomment %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- End Modal Dialog Scrollable-->
    
    <div class="modal fade" id="createAdminUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <form id = "adminUserForm" class="row g-3 needs-validation" method="post" novalidate >
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-center">Company Admin User Registration Form</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <br/>
                        {% csrf_token %}
                        <input type="hidden" name="form_prefix" value="{{ adminUserForm.prefix }}">
                        <div class="row mb-3">
                            <label for="admin_company" class="col-sm-2 col-form-label">Company</label>
                            <div class="col-sm-10">
                                {% render_field adminUserForm.company|add_class:"form-select"|attr:"id:admin_company" %}
                                <div id = "adminCompanyError" class="invalid-feedback">
                                    Select a company
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="admin_first_name" class="col-sm-2 col-form-label">First Name</label>
                            <div class="col-sm-10">
                                {% render_field adminUserForm.first_name|add_class:"form-control"|attr:"id:admin_first_name" %}
                                <div id = "adminFirstNameError" class="invalid-feedback">
                                    Provide a valid first name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="admin_last_name" class="col-sm-2 col-form-label">Last Name</label>
                            <div class="col-sm-10">
                                {% render_field adminUserForm.last_name|add_class:"form-control"|attr:"id:admin_last_name" %}
                                <div id = "adminLastNameError" class="invalid-feedback">
                                    Provide a valid last name
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="admin_email" class="col-sm-2 col-form-label">Email</label>
                            <div class="col-sm-10">
                                {% render_field adminUserForm.email|add_class:"form-control"|attr:"id:admin_email" %}
                                <div id = "adminEmailError" class="invalid-feedback">
                                    Provide a valid email
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="admin_phone_number" class="col-sm-2 col-form-label">Phone Number</label>
                            <div class="col-sm-10">
                                {% render_field adminUserForm.phone_number|add_class:"form-control"|attr:"id:admin_phone_number" %}
                                <div id = "adminPhoneNumberError" class="invalid-feedback">
                                    Provide a valid phone number
                                </div>
                            </div>
                        </div>
                        {% comment %} <button type="submit">Create Company</button> {% endcomment %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- End Modal Dialog Scrollable--> 
    
    <script type='text/javascript'>
        document.addEventListener('DOMContentLoaded', function () {
            // Get the active tab from localStorage or default to the first tab
            const activeTab = localStorage.getItem('activeTab') || 'users-tab';
            
            // Set the active tab based on the stored value
            const activeTabButton = document.getElementById(activeTab);
            if (activeTabButton) {
                activeTabButton.click();
            }
            
            // Add an event listener to store the active tab when a tab is clicked
            const tabButtons = document.querySelectorAll('.nav-tabs button');
            tabButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    const tabId = this.id;
                    localStorage.setItem('activeTab', tabId);
                });
            });
        });
        
        $(document).ready(function() {
            $("#selectUserTypeForm").submit(function(e){
                e.preventDefault();
                
                const selectedUserType = document.querySelector('input[name="user_type"]:checked');
                
                if (selectedUserType) {
                    $('#user_type_error').removeClass('d-block');
                    $('#user_type_error').addClass('d-none');
                    const value = selectedUserType.value;
                    // console.log(value);
                    $('#selectUserTypeModal').modal('hide');
                    if(value === "superUser"){
                        $('#createSuperUserModal').modal('show');
                    }else{
                        $('#createAdminUserModal').modal('show');
                    }
                } else {
                    $('#user_type_error').removeClass('d-none');
                    $('#user_type_error').addClass('d-block');
                }
                
            })
            
            $("#superUserForm").submit(function (e) {
                e.preventDefault();
                
                const data = $('#superUserForm').serialize() // Contains Form Data And CSRF Token As Well
                // console.log(data)
                
                $.ajax({
                    type: 'POST',
                    url: '{% url "user:super-all-users" %}',
                    data: data,
                    success: function (data) {
                        //console.log(data)
                        if (data.success) {
                            // Close the modal on success
                            $('#first_name').removeClass('is-invalid');
                            $('#first_name').addClass('is-valid');
                            $('#createCompanyModal').modal('hide');
                            window.location.reload()
                            // Optionally, you can redirect or perform other actions after a successful submission
                        } else {
                            console.log(data.errors)
                            
                            if(data.errors.first_name){
                                $('#first_name').removeClass('is-valid');
                                $('#first_name').addClass('is-invalid');
                                $('#firstNameError').text(data.errors.first_name[0])
                            }else{
                                $('#first_name').removeClass('is-invalid');
                                $('#first_name').addClass('is-valid');
                            }
                            
                            if(data.errors.last_name){
                                $('#last_name').removeClass('is-valid');
                                $('#last_name').addClass('is-invalid');
                                $('#lastNameError').text(data.errors.last_name[0])
                            }else{
                                $('#last_name').removeClass('is-invalid');
                                $('#last_name').addClass('is-valid');
                            }
                            
                            if(data.errors.email){
                                $('#email').removeClass('is-valid');
                                $('#email').addClass('is-invalid');
                                $('#emailError').text(data.errors.email[0])
                            }else{
                                $('#email').removeClass('is-invalid');
                                $('#email').addClass('is-valid');
                            }
                            
                            if(data.errors.phone_number){
                                $('#phone_number').removeClass('is-valid');
                                $('#phone_number').addClass('is-invalid');
                                $('#phoneNumberError').text(data.errors.email[0])
                            }else{
                                $('#phone_number').removeClass('is-invalid');
                                $('#phone_number').addClass('is-valid');
                            }
                            
                        }
                    }
                })
            })
            
            $("#adminUserForm").submit(function (e) {
                e.preventDefault();
                
                const data = $('#adminUserForm').serialize() // Contains Form Data And CSRF Token As Well
                // console.log(data)
                
                $.ajax({
                    type: 'POST',
                    url: '{% url "user:super-all-users" %}',
                    data: data,
                    success: function (data) {
                        //console.log(data)
                        if (data.success) {
                            // Close the modal on success
                            $('#id_name').removeClass('is-invalid');
                            $('#id_name').addClass('is-valid');
                            $('#createCompanyModal').modal('hide');
                            window.location.reload()
                            // Optionally, you can redirect or perform other actions after a successful submission
                        } else {
                            console.log(data.errors)
                            
                            if(data.errors.company){
                                $('#admin_company').removeClass('is-valid');
                                $('#admin_company').addClass('is-invalid');
                                $('#adminCompanyError').text(data.errors.company[0])
                            }else{
                                $('#admin_company').removeClass('is-invalid');
                                $('#admin_company').addClass('is-valid');
                            }
                            
                            if(data.errors.first_name){
                                $('#admin_first_name').removeClass('is-valid');
                                $('#admin_first_name').addClass('is-invalid');
                                $('#adminFirstNameError').text(data.errors.first_name[0])
                            }else{
                                $('#admin_first_name').removeClass('is-invalid');
                                $('#admin_first_name').addClass('is-valid');
                            }
                            
                            if(data.errors.last_name){
                                $('#admin_last_name').removeClass('is-valid');
                                $('#admin_last_name').addClass('is-invalid');
                                $('#adminLastNameError').text(data.errors.last_name[0])
                            }else{
                                $('#admin_last_name').removeClass('is-invalid');
                                $('#admin_last_name').addClass('is-valid');
                            }
                            
                            if(data.errors.email){
                                $('#admin_email').removeClass('is-valid');
                                $('#admin_email').addClass('is-invalid');
                                console.log(data.errors.email[0])
                                $('#adminEmailError').text(data.errors.email[0])
                            }else{
                                $('#admin_email').removeClass('is-invalid');
                                $('#admin_email').addClass('is-valid');
                            }
                            
                            if(data.errors.phone_number){
                                $('#admin_phone_number').removeClass('is-valid');
                                $('#admin_phone_number').addClass('is-invalid');
                                $('#adminPhoneNumberError').text(data.errors.email[0])
                            }else{
                                $('#admin_phone_number').removeClass('is-invalid');
                                $('#admin_phone_number').addClass('is-valid');
                            }
                            
                        }
                    }
                })
            })
            
        })
    </script>
    
    {% endblock %}