{% extends 'base/store/index.html' %}
{% load widget_tweaks %}


{% block pagetitle%}
<div class="pagetitle">
  <h1>Store : {{ store.name }}!</h1>

    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'user:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'user:users-store-roles-list' store_id=store.id %}">Roles</a></li>
            <li class="breadcrumb-item"><a href="#">List</a></li>
        </ol>
    </nav>
</div>
<!-- End Page Title --> 
{% endblock %} 

{% block content %}

<div class="container-fluid">
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Store Level Roles</h5>
            
            <div class="d-flex flex-column">
                <div class="d-flex flex-row justify-content-end">
                    {% if perms.user.manage_store_roles %}
                    <button class="btn btn-primary" style="width: 100px;" data-bs-toggle="modal" data-bs-target="#createRoleModal"><i class="bi bi-plus"></i><span>Add</span></button>
                    {% endif %}
                </div>
                <div>
                    <div class="table-responsive small">
                        <table id="bootstrapdatatable" class="datatable table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th scope="col">Store</th>
                                    <th scope="col">Role</th>
                                    <th scope="col">Group</th>
                                    <th scope="col">Action</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in store_groups %}
                                <tr>
                                    <td>{{item.store}}</td>
                                    <td>{{item.name}}</td>
                                    <td>{{item.group.name}}</td>
                                    <td><a href="{% url 'user:users-store-role-permissions-list' store_id=item.store.id group_id=item.group.id %}">
                                        View Permissions</a>
                                    </td>
                                    <td><a href="{% url 'user:users-store-role-permissions-edit' store_id=item.store.id group_id=item.group.id %}">
                                        <i class="bi bi-pencil"></i>Edit Permissions</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<div class="modal fade" id="createRoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center">Add New Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body row g-3 needs-validation">
                <form id = "roleForm" method="post" novalidate >
                    
                    {% csrf_token %}
                    <div class="row mt-1 mb-3">
                        <label for="name" class="col-sm-3 col-form-label">Name</label>
                        <div class="col-sm-9">
                            {% render_field form.name|add_class:"form-control"|attr:"id:name" %}
                            <div id = "nameError" class="invalid-feedback">
                                Provide a valid name
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id ="formSubmitButton" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- End Modal Dialog Scrollable-->

<script type='text/javascript'>
    
    $(document).ready(function() {  
        $("#formSubmitButton").click(function () {
            
            const data = $('#roleForm').serialize() // Contains Form Data And CSRF Token As Well
            
            $.ajax({
                type: 'POST',
                url: '{% url "user:users-store-roles-list" 0 %}'.replace('0', {{store.id}}),
                data: data,
                success: function (data) {
                    // console.log(data)
                    if (data.success) {
                        // Close the modal on success
                        $('#name').removeClass('is-invalid');
                        $('#name').addClass('is-valid');
                        
                        $('#createRoleModal').modal('hide');
                        window.location.reload()            
                        // Optionally, you can redirect or perform other actions after a successful submission
                    } else {
                        if(data.errors.name){
                            $('#name').removeClass('is-valid');
                            $('#name').addClass('is-invalid');
                            $('#nameError').text(data.errors.name[0])
                        }else{
                            $('#name').removeClass('is-invalid');
                            $('#name').addClass('is-valid');
                        }
                    }
                }
            })
        })
    })
</script>
{% endblock %}