{% extends 'base/store/index.html' %}
{% load widget_tweaks %}

{% block pagetitle%}
<div class="pagetitle">
    <h1>Store : {{ store.name }}!</h1>
    
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="#">Home</a></li>
            <li class="breadcrumb-item"><a>Sales</a></li>
            <li class="breadcrumb-item active"><a>New</a></li>
        </ol>
    </nav>
</div><!-- End Page Title --> 
{% endblock %} 


{% block content%}  

<div class="card">
    <div class="card-body">
        <h5 class="card-title"> New Sale Form</h5>
        
        <form class="row g-3 needs-validation" method="post" novalidate >
            
            {% csrf_token %}
            
            <div class="row">
                
                <div class="col-12">  
                    
                    <div class="mt-2 row">
                        <div class="col-sm-3">
                            Point Of Sale (POS)
                        </div>
                        <div class="col-sm-9">
                            {% if form.errors.pos_center %}
                            {% render_field form.pos_center|add_class:"form-control is-invalid"%}
                            <div class="invalid-feedback">
                                {{ form.errors.pos_center.0 }}
                            </div>
                            {% else %}
                            {% render_field form.pos_center|add_class:"form-control"%}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-2 row">
                        <div class="col-sm-3">
                            Add Product
                        </div>
                        <div class="col-sm-9">
                            <select id = "selectedProduct" class="col-sm-12 form-select js-select-products" name="state">
                                <option value="">--</option>
                                {% for store_product in store_products %}
                                <option 
                                value="{{ store_product.id }}"
                                data-price="{{ store_product.unit_price }}"
                                >{{store_product.product.name}}</option>
                                {% endfor %} 
                            </select>
                        </div>
                    </div>
                    
                    <hr class="mt-2 mb-1"/>
                    
                    <h5 class="card-title py-1">Cart Items</h5>
                    
                    <hr class="mt-1"/>
                    
                    
                    {% comment %} <div class="d-flex flex-row justify-content-end d-block add-formset-item">
                        <a class = "add-form text-primary" style = "width: 150px; height:30px; display: inline-block; text-align: center; text-decoration: none;"><i class="bi bi-plus"></i><span>Add Item</span></a>
                    </div> {% endcomment %}
                    
                    
                    <div id="empty-form" style="display:none;">
                        <div class="empty-form-row my-2">
                            <div class="row">
                                {% comment %} <div class="col-md-2">Product</div> {% endcomment %}
                                <div class="col-md-4">
                                    {% if empty_form.errors.store_product %}
                                    {% render_field empty_form.store_product|add_class:"form-control is-invalid"|attr:"disabled"%}
                                    <div class="invalid-feedback">
                                        {{ empty_form.errors.store_product.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field empty_form.store_product|add_class:"form-control"|attr:"disabled"%}
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" name="test_items-0-price" disabled />
                                </div>
                                {% comment %} <div class="col-md-2">Qty</div> {% endcomment %}
                                <div class="col-md-3">
                                    {% if empty_form.errors.quantity %}
                                    {% render_field empty_form.quantity|add_class:"form-control is-invalid"%}
                                    <div class="invalid-feedback">
                                        {{ empty_form.errors.quantity.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field empty_form.quantity|add_class:"form-control"%}
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" name="test_items-0-sub_total" disabled />
                                </div>
                                <div class="col-md-1">
                                    <span class="remove-form text-danger text-center" style = "width: 50px; height:30px; display: inline-block; text-align: center;"><i class="bi bi-trash"></i></span>
                                </div>
                            </div>
                            
                            {% comment %} <div class="d-flex flex-row justify-content-end d-block remove-formset-item">
                                <a class = "remove-form text-danger" style = "width: 150px; height:30px; display: inline-block; text-align: center; text-decoration: none;"><i class="bi bi-trash"></i><span></span></a>
                            </div> {% endcomment %}
                            
                            <hr class="text-primary" />
                        </div>
                    </div>
                    
                    {{ formset.management_form }}
                    <div class= "form-container bg-light" style="min-height: 200px;" >
                        <div id="emptyCart" class="d-none flex-column align-items-center justify-content-center" style="min-height: 200px;">
                            <p>Cart Is Empty</p>
                        </div>
                        {% comment %} <div id="cartItems" class="row"> {% endcomment %}
                            <div id="cartItems" class="d-none">
                                <div class="col-4 text-center">Product</div>
                                <div class="col-2 text-center">Price</div>
                                <div class="col-3 text-center">Qty</div>
                                <div class="col-2 text-center">Sub Total</div>
                                <div class="col-1 text-center"></div>
                            </div>
                            
                            {% comment %} <div  class="form-row my-2"></div> {% endcomment %}
                        </div>   
                    </div> 
                </div>  
                
                <div class="row">
                    <div class="col-sm-6">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="customer_name" class="col-sm-12 col-form-label">Customer Name</label>
                                <div class="col-sm-12">
                                    {% if form.errors.customer_name %}
                                    {% render_field form.customer_name|add_class:"form-control is-invalid"|attr:"id:customer_name" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.customer_name.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.customer_name|add_class:"form-control"|attr:"id:customer_name" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                    <div class="col-sm-6">
                        <div class="row mb-3">                        
                            <div class="col-sm-12">
                                <label for="customer_phone" class="col-sm-12 col-form-label">Customer Phone</label>
                                <div class="col-sm-12">
                                    {% if form.errors.customer_phone %}
                                    {% render_field form.customer_phone|add_class:"form-control is-invalid"|attr:"id:customer_phone" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.customer_phone.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.customer_phone|add_class:"form-control"|attr:"id:customer_phone" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-sm-6">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="customer_email" class="col-sm-12 col-form-label">Customer Email</label>
                                <div class="col-sm-12">
                                    {% if form.errors.customer_email %}
                                    {% render_field form.customer_email|add_class:"form-control is-invalid"|attr:"id:customer_email" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.customer_email.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.customer_email|add_class:"form-control"|attr:"id:customer_email" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                    
                    <div class="col-sm-6">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="customer_address" class="col-sm-12 col-form-label">Customer Address</label>
                                <div class="col-sm-12">
                                    {% if form.errors.customer_address %}
                                    {% render_field form.customer_address|add_class:"form-control is-invalid"|attr:"id:customer_address" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.customer_address.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.customer_address|add_class:"form-control"|attr:"id:customer_address" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-sm-6">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="payment_option" class="col-sm-12 col-form-label">Payment Option</label>
                                <div class="col-sm-12">
                                    {% if form.errors.payment_option %}
                                    {% render_field form.payment_option|add_class:"form-control is-invalid"|attr:"id:payment_option" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.payment_option.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.payment_option|add_class:"form-control"|attr:"id:payment_option" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                    
                    <div class="col-sm-6">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="payment_details" class="col-sm-12 col-form-label">Payment Details</label>
                                <div class="col-sm-12">
                                    {% if form.errors.payment_details %}
                                    {% render_field form.payment_details|add_class:"form-control is-invalid"|attr:"id:payment_details" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.payment_details.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.payment_details|add_class:"form-control"|attr:"id:payment_details" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div> 
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-sm-12">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <label for="sale_remarks" class="col-sm-12 col-form-label">Comments / Remarks</label>
                                <div class="col-sm-12">
                                    {% if form.errors.sale_remarks %}
                                    {% render_field form.sale_remarks|add_class:"form-control is-invalid"|attr:"id:sale_remarks" rows="3" %}
                                    <div class="invalid-feedback">
                                        {{ form.errors.sale_remarks.0 }}
                                    </div>
                                    {% else %}
                                    {% render_field form.sale_remarks|add_class:"form-control"|attr:"id:sale_remarks" rows="3" %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>  
                    </div>
                </div>
                
                <div class="col-12 d-flex justify-content-center mt-5">
                    <button class="btn btn-primary" type="submit" style="width: 300px;">Add New Sale</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type='text/javascript'>
        
        $(document).ready(function() {
            
            $('.js-select-products').select2();
            
        })
        
        
        $('#selectedProduct').on('change', function() {
            // Get the selected value
            var selectedValue = $(this).val();
            
            // Log or do something with the selected value
            // console.log('Selected Product ID:', selectedValue);
            
            var selectedOption = $(this).find('option:selected');
            
            var price = selectedOption.data('price');
            
            // Access the cost value and do something with it
            // console.log('Selected price:', price);
            
            addForm('.form-row:last', 'items', selectedValue, price);
            
            // var tt = $('#id_items-TOTAL_FORMS');
            // console.log(tt.val());
        });
        
        
        $(document).ready(function() {
            var tt = $('#id_items-TOTAL_FORMS');        
            var noOfItems = tt.val();
            
            var emptyCart = $("#emptyCart");
            var cartItems = $("#cartItems");
            
            if (noOfItems == 0){
                console.log("here 1");
                emptyCart.removeClass('d-none').addClass('d-flex') // Display
                cartItems.removeClass('row').addClass('d-none') // Dont Display
            }else{
                console.log("here 11");
                emptyCart.removeClass('d-flex').addClass('d-none') // Dont Display
                cartItems.removeClass('d-none').addClass('row') // Display
            }
            
            // Attach a 'change' event listener
            tt.on('change', function() {
                var newValue = tt.val();
                noOfItems = newValue;
                
                console.log(noOfItems);
                if (noOfItems == 0){
                    console.log("here 1");
                    emptyCart.removeClass('d-none').addClass('d-flex') // Display
                    cartItems.removeClass('row').addClass('d-none') // Dont Display
                }else{
                    console.log("here 11");
                    emptyCart.removeClass('d-flex').addClass('d-none') // Dont Display
                    cartItems.removeClass('d-none').addClass('row') // Display
                }
            });
            
        });
        
        
        function addForm(selector, prefix, selectProductId, selectProductPrice) {
            var formContainer = $('.form-container');
            
            // Count the number of child elements with class 'row'
            var formRowCount = formContainer.find('.form-row').length;
            
            var newElement = $('.empty-form-row').clone(true);
            
            if(formRowCount > 0){
                console.log("formRowCount", formRowCount)
                newElement = $(selector).clone(true);
            }
            
            newElement.removeClass('empty-form-row').addClass('form-row');
            // newElement.removeClass('empty-form-row');
            
            var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
            
            newElement.find('select').each(function(){
                var name = $(this).attr('name').replace('test_items', 'items').replace('-' + (total) + '-', '-' + (Number(total)+1) + '-');
                // var name = $(this).attr('name').replace('-' + (total-1) + '-', '-' + total + '-');
                
                var id = 'id_' + name;
                
                $(this).attr({'name': name, 'id': id}).val('');
                // $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
                
                var selectedOption = $(this).find('option:selected');
                var notSelectedOptions = $(this).find('option:not(selected)');
                
                notSelectedOptions.each(function(e){
                    if (selectProductId == $(this).val()) {
                        $(this).prop('selected', true);
                    }
                    
                })
            }) 
            
            newElement.find('input').each(function() {
                var forValue = $(this).attr('name');
                if (forValue) {
                    forValue = forValue.replace('test_items', 'items').replace('-' + (total) + '-', '-' + (Number(total)+1) + '-');;
                    var id = 'id_' + forValue;
                    $(this).attr({'id': id});
                    $(this).attr({'name': forValue});
                    $(this).attr({'for': forValue});
                    
                    if (forValue.includes("price")) {
                        $(this).val(selectProductPrice);
                    }
                }
                
            });
            
            total++;  
            
            //$('#id_' + prefix + '-TOTAL_FORMS').val(total);
            $('#id_' + prefix + '-TOTAL_FORMS').val(total).trigger('change')
            
            // $(selector).append(newElement);
            $('.form-container').append(newElement);
            
        }
        
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+)');
            var replacement = prefix + '-' + ndx;
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }
        
        function deleteForm(prefix, btn) {
            var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            // console.log(total)
            if (total > 0){
                btn.closest('.form-row').remove();
                var forms = $('.form-row');
                // $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length).trigger('change')
                for (var i=0, formCount=forms.length; i<formCount; i++) {
                    $(forms.get(i)).find(':input').each(function() {
                        updateElementIndex(this, prefix, i);
                    });
                }
            }
            return false;
        }
        
        
        $(document).on('click', '.remove-form', function(e){
            e.preventDefault();
            //console.log(" Deleting ")
            deleteForm('items', $(this));
            return false;
        });
        
    </script>
    
    
    {% endblock %}
    
    